ClickHouse Prometheus Exporter
–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä –º–µ—Ç—Ä–∏–∫ –∏–∑ ClickHouse –≤ Prometheus. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ ClickHouse –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å Prometheus, –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

–£—Å—Ç–∞–Ω–æ–≤–∫–∞

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ó–∞–ø—É—Å–∫

–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

–ú–µ—Ç—Ä–∏–∫–∏

Docker

–õ–∏—Ü–µ–Ω–∑–∏—è

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ ClickHouse.

–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ª–µ–π–±–ª–æ–≤.

–≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å Prometheus.

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ SSL/TLS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ClickHouse.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
Go 1.19 –∏–ª–∏ –≤—ã—à–µ.

ClickHouse (–≤–µ—Ä—Å–∏—è 21.x –∏–ª–∏ –≤—ã—à–µ).

Prometheus (–¥–ª—è —Å–±–æ—Ä–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫).

–£—Å—Ç–∞–Ω–æ–≤–∫–∞
–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

bash
Copy
git clone https://github.com/yourusername/clickhouse-prometheus-exporter.git
cd clickhouse-prometheus-exporter
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

bash
Copy
go mod download
–°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:

bash
Copy
go build -o clickhouse-prometheus-exporter ./cmd/exporter/main.go
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–¥–∞—ë—Ç—Å—è –≤ —Ñ–∞–π–ª–µ config/queries.yaml. –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

yaml
Copy
servers:
  - name: "server1"
    dsn: "tcp://localhost:9000?username=default&password=&database=default"
    ca_cert_path: "/path/to/ca.crt"  # –ü—É—Ç—å –∫ CA-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

queries:
  - name: "total_users"
    query: "SELECT COUNT(*) as total, department FROM users GROUP BY department"
    metric_name: "clickhouse_total_users"
    help: "Total number of users in the database by department"
    type: "gauge"
    value_column: "total"
    labels: ["department"]
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
servers:

name: –ò–º—è —Å–µ—Ä–≤–µ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ª–µ–π–±–ª).

dsn: DSN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ClickHouse.

ca_cert_path: –ü—É—Ç—å –∫ CA-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É (–¥–ª—è SSL/TLS, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

queries:

name: –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è).

query: SQL-–∑–∞–ø—Ä–æ—Å –∫ ClickHouse.

metric_name: –ò–º—è –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus.

help: –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏.

type: –¢–∏–ø –º–µ—Ç—Ä–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, gauge).

value_column: –°—Ç–æ–ª–±–µ—Ü, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏.

labels: –°—Ç–æ–ª–±—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞–∫ –ª–µ–π–±–ª—ã.

–ó–∞–ø—É—Å–∫
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä:

bash
Copy
./clickhouse-prometheus-exporter -config /path/to/config.yaml
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª config/queries.yaml, –µ—Å–ª–∏ —Ñ–ª–∞–≥ -config –Ω–µ —É–∫–∞–∑–∞–Ω.

–ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å—É:

Copy
http://localhost:8080/metrics
–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
–¢–æ–ø-10 –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–º–µ—Ä—É
sql
Copy
SELECT
    database AS db_name,
    sum(bytes) AS db_size_bytes
FROM system.tables
GROUP BY database
ORDER BY db_size_bytes DESC
LIMIT 10;
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
sql
Copy
SELECT
    user,
    COUNT(*) AS active_sessions
FROM system.processes
GROUP BY user;
–ú–µ—Ç—Ä–∏–∫–∏
–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü—Ä–∏–º–µ—Ä –º–µ—Ç—Ä–∏–∫–∏:

Copy
clickhouse_total_users{server="server1", department="HR"} 10
clickhouse_total_users{server="server1", department="IT"} 20
Docker
–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:

–°–æ–±–µ—Ä–∏—Ç–µ Docker-–æ–±—Ä–∞–∑:

bash
Copy
docker build -t clickhouse-prometheus-exporter .
–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

bash
Copy
docker run -d -p 8080:8080 --name clickhouse-exporter clickhouse-prometheus-exporter
–õ–∏—Ü–µ–Ω–∑–∏—è
–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ LICENSE.

–ê–≤—Ç–æ—Ä—ã
–í–∞—à–µ –∏–º—è

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–π—Ç–µ issue –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π.

–≠—Ç–æ—Ç README.md —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –í—ã –º–æ–∂–µ—Ç–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã. üòä